---
title: "Creating Visualizations with ggplot2"
subtitle: "Data Science with R &#183; Summer 2020"
author: "Uli Niemann"
session: "03"
institute: "Knowledge Management & Discovery Lab"
# date: "2016/12/12 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    css: ["default", "assets/css/my-theme.css", "assets/css/my-fonts.css"]
    seal: false # custom title slide
    lib_dir: libs
    nature:
      # highlightStyle: solarized-light
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: true
      ratio: "16:9"
params:
  url: "https://brain.cs.uni-magdeburg.de/kmd/DataSciR/"
---

```{r setup, include=FALSE}
Sys.setlocale("LC_ALL","English")
Sys.setenv(LANG = "en_US.UTF-8")
Sys.setlocale("LC_TIME", "English")

# The version number in the directory name of an HTML dependency can be
# suppressed by setting options(htmltools.dir.version = FALSE) when the
# dependency is copied via `copyDependencyToDir()`. 
options(htmltools.dir.version = FALSE)
options(width = 90) # width of console output
# load fonts (mainly Fira Sans)
# extrafont::font_import()
extrafont::loadfonts("win", quiet = TRUE)

yt_counter <- 0

# set default knitr options
knitr::opts_chunk$set(fig.width = 15/2.54, fig.height = 11/2.54, fig.retina = 4)
knitr::opts_chunk$set(eval = TRUE, echo = TRUE, warning = TRUE, 
                      message = FALSE, cache = TRUE)
# directory of generated figures
knitr::opts_chunk$set(fig.path = "figures/_gen/03-ggplot2/")
# directory of included figures
fig_path <- "figures/03-ggplot2/"

ggplot2::theme_set(ggplot2::theme_gray(base_size = 18, base_family = "Fira Sans"))

library(countdown)
library(ggplot2)
library(dplyr)
library(gapminder)
library(ggiraph)
```

class: title-slide, center, bottom

# `r paste(rmarkdown::metadata$session, "-", rmarkdown::metadata$title)`

## `r rmarkdown::metadata$subtitle`

### `r rmarkdown::metadata$author` &#183; `r rmarkdown::metadata$institute`

#### [`r params$url`](`r params$url`)

.courtesy[&#x1F4F7; Photo courtesy of Ulrich Arendt]

---

## Why visualize data?

.pull-left60[

Visualization is...

- ...part of **exploratory data analysis**: understand distributions, identify outliers & missing data
- ...part of **feature engineering**: discover relationships between two or more predictors and extract a new predictor to increase model performance
- ...part of **model presentation**: show clusters, dimension reductions, etc.
- ...part of **model evaluation**: graphically describe the performance of one or 
more inferential or predictive models
- ...part of **storytelling**: convincingly communicate a data-driven finding

]

.pull-right40[

```{r, echo=FALSE, out.width="100%", fig.align='center'}
# knitr::include_graphics(file.path(fig_path, "anscombe.png"))
knitr::include_graphics(file.path(fig_path, "africa.png"))
```

.font50[Figure source: Kieran Healy. ["Data Visualization. A practical introduction"](http://socviz.co/). Princeton University Press, 2018.]

]

???

- _"A picture is worth a thousand words."_ - English language-idiom
- easier to comprehend than by looking at statistical summaries
- for most humans it is quite difficult to extract the answers on questions about the data just from staring at large tables.
- data visualization provides a powerful way to communicate a data-driven finding
- sometimes it is so convincing that no follow-up analysis is required
- many widely used data analysis tools were initiated by discoveries made via EDA



---

background-image: url("figures/03-ggplot2/greatest-hits-6.png")
background-size: contain

.pull-left70[&nbsp;]
.pull-right30[.footnote[.content-box-gray[.font80[[Source](http://johnburnmurdoch.github.io/slides/r-ggplot/greatest-hits-6.png)]]]]

???

- relationship between the percentage of people with a degree (x-axis) and share of people who voted for leave (y-axis)
- a point represents one single british area
- size = population size; 
- color separates English areas from Scottish areas
- red points are non-scottish british areas; blue points are Scottish areas
  - dark red -> London ; light red -> rest of britain
- the plot shows a clear general trend, highlighted by the regression lines: the higher the perc. of people with a degree in an area, the lower the vote percentage for leaving the EU
- the general british trend applies also on scotland, but independently from the percentage of people with a degree, the share of EU-enemies is lower than in the rest of GB
- also the slope of the regression line is less steep, indicating that this group is more homogeneous than the rest of the country

---

class: middle

```{r harvard-corruption-human-dev, echo=FALSE, out.width="50%", fig.align='center'}
knitr::include_graphics(file.path(fig_path, "harvard_ggplot2_tutorial.png"))
```

.pull-left70[&nbsp;]

.pull-right30[.footnote[.content-box-gray[.font80[[Source](https://tutorials.iq.harvard.edu/R/Rgraphics/Rgraphics.html)]]]]


---

background-image: url("figures/03-ggplot2/ggplot2_switzerland_map.png")
background-size: contain

.pull-left70[&nbsp;]
.pull-right30[.footnote[.content-box-gray[.font80[[Source](https://timogrossenbacher.ch/2016/12/beautiful-thematic-maps-with-ggplot2-only/)]]]]

---

background-image: url("figures/03-ggplot2/bbc_graphics.jpg")
background-size: contain

.pull-left70[&nbsp;]

.pull-right30[.footnote[.content-box-gray[.font80[[Source](https://bbc.github.io/rcookbook/)]]]]

---

class: middle

## Disclaimer

.content-box-red[

&#x26A1; Beware that most of the following examples of graphics do not strictly adhere to [good graphical principles](https://graphicsprinciples.github.io/) 
for quantitative scientists.

They serve to illustrate how to use the API of ggplot2.

Principles for effective visual communication and good practices of graph design 
can be found under <https://graphicsprinciples.github.io/>.

The book ["Fundamentals of Data Visualization"](https://serialmentor.com/dataviz/) 
by Claus O. Wilke contains a comprehensive yet concise overview of various plot 
types, tips on when to use them and also "dont's" for each visualization problem.

[WTF Visualizations](https://viz.wtf/) is a blog on visualizations "that make no sense".  

]

???

!= tutorial of good chart design

---

## `ggplot2` &#x1F4C8;

.footnote[[1] Leland Wilkinson. _The grammar of graphics._ Springer Science & Business Media, 2006.]

.pull-left70[

> [`ggplot2`](https://ggplot2.tidyverse.org/index.html) is a package for **data visualization**.

&#x1F914; _"...but base R already includes inbuilt plotting capabilities. Why should we care about `ggplot2`?"_

- `ggplot2` is inspired by the **Grammar of Graphics**<sup>1</sup>
-  idea: **break the graph into components** and **handle each component individually** $\rightarrow$ ensure versatility and control
- a `ggplot2` chart is built by stacking a **series of layers**
- advantage: build a **variety of different charts** with the same vocabulary $\rightarrow$ code that is easier to read and write

]

.pull-right30[

```{r, echo=FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "hex-ggplot2.png"))
```

]


???

- basic idea of gg: no matter whether you would like to draw a pie chart, a line chart, 
a bar chart or a scatterplot, what you always do is create a **graphic**
- but what is a graphic: a graphic can be decomposed into multiple layers
- instead of having different "super"-functions for every possible chart type 
like in base R, the idea of gg is to describe a large variety of different charts 
with the same vocabulary
- ggplot is a specific implementation of gg
  - goal: create informative and elegant graphs with relatively simple and readable code
  - part of the tidyverse -> works exclusevly with data frames
  - requires tidy data frames

versatility - Vielseitigkeit, Flexibilität

umfangreich, intuitiv und flexibel

<!-- - default behaviour is carefully chosen to satisfy the great majority of cases and are aesthetically pleasing -->
<!-- - it is possible to create informative and elegant graphs with relatively simple and readable code -->
<!-- - limitation: since ggplot is part of the tidyverse, it is very data frame centric, so it is designed to work exclusively with data tables -> advantage: assuming that the data follows this format, it simplifies the code and learning the grammar  -->

<!-- So far, we have covered some EDA approaches for _univariate_ data, e.g. histograms, qq-plots and boxplots. Now, learn more details and introduce some tools and summary statistics for paired data. We do this using the powerful `ggplot2` package. -->

<!-- versatility - Vielseitigkeit, Flexibilität -->

<!-- umfangreich, intuitiv und flexibel -->

---

## Components of a graphic

```{r gg-gif, echo=FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "grammar_of_graphics.gif"))
```

.footnote[.font90[Figure: Thomas de Beus. ["Think About the Grammar of Graphics When Improving Your Graphs"](https://medium.com/tdebeus/think-about-the-grammar-of-graphics-when-improving-your-graphs-18e3744d8d18). Medium, 2017.]]

---

## `ggplot2` vocabulary 

<!-- .footnote[[1] [`ggplot2` function reference](http://ggplot2.tidyverse.org/reference/)] -->

.pull-left60[

- **data**: the actual data that is plotted as _tidy_ data frame
- **aesthetics/mapping**: **map variables to visual properties**
  - x- and y-coordinates, color, shapes, transparency, line type
- **geoms** - geometric objects
  - points, bars, lines, histograms, etc.
- **stats** - data transformations (often implicit)
  - counts of categories for bar charts, summary statistics for a boxplot, regression parameters, etc.
- **scales** - translate between variable ranges and visual properties
  - which color should represent which category?, should the y-axis be log-transformed? 
- **facets** - spread data onto multiple subplots/panels
- **coordinates** - change and adjust the coordinate system
  - cartesian, polar or cartographic coordinate system
- **themes** - additional visual settings not related to the data
  - font size or background color

]

.pull-right40[

```{r gg-components, echo=FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "gg_components.png"))
```

]

???

- stats: convert raw data into new data which gets plotted
- scales: translate between data values and properties of the plot
- coordinates: physical position of the points, lines, etc. on the paper

---


## Our first `ggplot` graph

To generate our first `ggplot2` graph, we will use the "Gapminder" dataset which 
contains global health and economic data for 142 countries between 1952 and 2007 
in increments of 5 years.

.pull-left[

```{r, R.options=list(width = 50)}
library(dplyr)
library(gapminder)
gapminder
```

]

.pull-right[

```{r, echo=F}
knitr::kable(tibble(variable = names(gapminder), ` ` = c("factor with 142 levels",
                                                             "factor with 5 levels",
                                                             "1952 to 2007 in increments of 5 years",
                                                             "life expectancy at birth [years]",
                                                             "population",
                                                             "GDP per capita [US$]")),
             format = "html"
) %>%
  kableExtra::kable_styling(position = "left")
```

<!-- &nbsp; -->

<iframe width="445" height="250" src="https://www.youtube.com/embed/jbkSRLYSojo?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>

<!-- .font50[[Video URL](https://youtu.be/jbkSRLYSojo)] -->


]

---

## Our first `ggplot` graph

The first step in creating a `ggplot2` graph is to define a `ggplot` object with the `ggplot()` function.  
The main arguments are: 

- `data`: the data frame associated with the graph
- `mapping`: the _aesthetical_ mapping, e.g. which variables from the data will be mapped 
to the x- or y-position, color, shape, transparency etc.

--

After initializing the graph, you continuously stack **layers** on top of (like LEGO blocks) with the `+` operator.

.pull-left60[

For example, we would like to create a graph from the gapminder data, showing `gdpPercap` and `lifeExp` as scatterplot **geom**etry.

```{r first-ggplot, eval = FALSE}
library(ggplot2)
ggplot(data = gapminder,
       mapping = aes(x = gdpPercap, y = lifeExp)) +
  geom_point()
```

```{r reprex, eval=FALSE, include = FALSE}
library(reprex)
reprex({
  ggplot(markets, aes(x = alter, y = score)) +
    geom_point()
})
```

]

.pull-right40[

```{r, ref.label='first-ggplot', echo = FALSE}

```

]

???

- important: no quotes, no gapminder$xxx, because these expressions are not evaluated immediately


---

class: middle

```{r syntax, echo=FALSE, fig.align='center', out.width="100%"}
knitr::include_graphics(file.path(fig_path, "ggplot2_syntax.png"))
```

???

- which dataset to plot
- which columns to use for x and y
- how to draw the plot
- + to combine ggplot2 elements

---

```{r}
p <- ggplot(data = gapminder, mapping = aes(x = gdpPercap, y = lifeExp))
```

--

.pull-left[

```{r}
# Add a scatterplot layer
p + geom_point()
```

]

--

.pull-right[

```{r}
# Add a trend line layer
p + geom_smooth(method = "lm")
```

]

---

## Adding multiple geoms layer by layer

```{r}
# Add both scatterplot layer and trend line layer
p +
  geom_point() +
  geom_smooth(method = "lm")
```

---

## Geoms

.pull-left70[

```{r gg-ref, echo=FALSE, out.width="100%"}
knitr::include_url("https://ggplot2.tidyverse.org/reference#section-layer-geoms", height = "600px")
# knitr::include_graphics(file.path(fig_path, "ggplot2_doc_geoms.png"))
```

]

.pull-right30[

.footnote[

[`ggplot2` function reference with an overview of all available geoms](https://ggplot2.tidyverse.org/reference/)

]

]

---

class: middle, exercise-blue

## Your turn `r (yt_counter <- yt_counter + 1)`

Recreate the boxplots graph below. It shows the GDP distribution for each continent in 2007. 

`r countdown::countdown(minutes = 3)`

```{r echo=FALSE, fig.align='center', out.width="50%"}
knitr::include_graphics(file.path(fig_path, "yt1.png"))
```

---

## Further aesthetics

```{r shapes, echo=FALSE, fig.width=25/2.54, fig.height=20/2.54, fig.align='center'}
tt <- theme_get() +
  theme(text = element_text(size = 40)) +
  theme(axis.text = element_blank()) +
  theme(axis.ticks = element_blank()) +
  theme(axis.title = element_blank())
library(patchwork)
ggplot(data.frame(x=1,y=1), aes(x,y)) + 
  geom_point(shape = 20, size = 40, fill = "black") +
  tt +
  ggplot(data.frame(x=1,y=1), aes(x,y)) + 
  geom_point(shape = 20, size = 15, fill = "black") +
  labs(title = "size") +
  tt +
  ggplot(data.frame(x=1,y=1), aes(x,y)) + 
  geom_point(shape = 17, size = 40, fill = "black") +
  labs(title = "shape") +
  tt + 
  ggplot(data.frame(x=1,y=1), aes(x,y)) + 
  geom_point(shape = 20, size = 40, color = "blue") +
  labs(title = "color") +
  tt +
  ggplot(data.frame(x=1,y=1), aes(x,y)) + 
  geom_point(shape = 21, size = 40, color = "blue", fill = "pink", stroke = 2) +
  labs(title = "color+fill") +
  tt +
  ggplot(data.frame(x=1,y=1), aes(x,y)) + 
  geom_point(shape = 20, size = 40, fill = "black", alpha = 0.25) +
  labs(title = "alpha") +
  tt
```

???

- so far, we have made two mappings: one variable represents x-position and one variable represents y-position

---

## Further aesthetics

.pull-left70[

```{r aes-color, fig.width=20/2.54, fig.height=12/2.54}
ggplot(gapminder, aes(
  x = gdpPercap, y = lifeExp, 
  color = continent #<<
)
) +
  geom_point()
```

]

.pull-right30[

color | &nbsp; | continent
----: | :----: | :----
<span style="color: #f8766d;">red</span> | &xharr; | Africa
<span style="color: #a3a500;">olive</span> | &xharr; | Americas
<span style="color: #00bf7d;">green</span> | &xharr; | Asia
<span style="color: #00b0f6;">blue</span> | &xharr; | Europe
<span style="color: #e76bf3;">pink</span> | &xharr; | Oceania

.content-box-blue[

By default, `ggplot2` always creates a legend for mapping variables.

]

]


---

class: middle, exercise-blue

## Your turn `r (yt_counter <- yt_counter + 1)`

`r countdown::countdown(minutes = 3)`

Recreate the depicted line plot which shows the population development for France, Germany and Italy over time.

```{r, echo=FALSE, fig.align='center', out.width="50%"}
knitr::include_graphics(file.path(fig_path, "yt2.png"))
```

???

```{r pop-line, echo=FALSE, fig.width=6, fig.height=4, fig.align='center', eval=FALSE}
```

- ggplot2 automatically creates a color scale.

---

## Global vs. local aesthetics

We can specify the aesthetic mapping either **globally** within the `ggplot()` function or 
**individually** for a specific layer within a `geom_*()` function.

If set globally, the aesthetic mapping takes effect on **all** geom layers.

```{r fig.width=7}
# continent is mapped to color for all underlying layers
p <- ggplot(data = gapminder,
            mapping = aes(x = gdpPercap, y = lifeExp, color = continent)) #<<
p + geom_point() +
    geom_smooth(method = "lm") +
    scale_x_log10()
```

---

## Global vs. local aesthetics


```{r fig.width=7}
# continent is mapped to color only for scatterplot layer
p <- ggplot(data = gapminder,
            mapping = aes(x = gdpPercap, y = lifeExp)) #<<
p + geom_point(mapping = aes(color = continent)) + #<<
    geom_smooth(method = "lm") +
    scale_x_log10()
```

.footnote[

Note that the legend keys have also changed. Since the color mapping does not 
apply on the regression line anymore, the legend keys only show a point instead 
of a point and a line.

]

---

## Non-aesthetic layer arguments

Layer arguments that are independent from the underlying data frame are 
set outside of `aes()`.

For example, we can make some cosmetic adjustments by setting the points' color 
and transparency (_alpha_), the line's color and size. Further, we remove the 
confidence interval of the fit.

```{r}
p +
  geom_point(alpha = 0.3, color = "cornflowerblue") + #<<
  geom_smooth(method = "lm",
              color = "firebrick", se = FALSE, size = 2) + #<<
  scale_x_log10()
```

???

Beispiele für Layer-Argumente:

- alpha: Transparenz hinzufügen, um überlappende Punkte zu erkennen
- se: kein Konfidenzintervall für die Regressionsgerade
- size, color: etwas dickere rote Linie

---

class: middle

The following example shows a typical incorrect use of geom arguments. 
We would like to show multiple boxplots depicting the distribution of GDP/capita for each continent and 
adjust the boxplots' line size to `0.75`. 

.pull-left[

```{r}
ggplot(gapminder) + geom_boxplot(
  aes(x = "continent", y = gdpPercap, 
      size = 0.75)
)
```

&#x1F914; _What went wrong here?_

] 

???

- show a box for each continent
- size is larger than 0.75
- do not need a label for size


--

.pull-right[

.content-box-yellow[

To fix the two problems of the code, we have to adhere to the following 
principles:

1. Within `aes()`, variables names must be passed as **expressions**, i.e., **without quotes**. 
1. **Non-aesthetic arguments** must be set **outside** of `aes()`.

]


]


???

- `aes()` uses NSE

---

class: middle

.pull-left[

<center>.font150[&#x1F62D;]</center>

```{r}
ggplot(gapminder) + geom_boxplot(
  aes(x = "continent", y = gdpPercap, 
      size = 0.75)
)
```

] 

.pull-right[

<center>.font150[&#x1F60A;]</center>

```{r, fig.width=14/2.54}
ggplot(gapminder) + geom_boxplot(
  aes(x = continent, y = gdpPercap), #<< 
  size = 0.75 #<<
)
```

]

---

class: exercise-blue, middle

## Quiz

Why are the bars of the histogram colored in red although we have specified 
a blue color?

```{r histo-steelblue-1, fig.width=16/2.54}
ggplot(gapminder) + 
  geom_histogram(aes(x = gdpPercap, fill = "steelblue"))
```

---

## Stats

**Stats** are linked to geometries. Every geom has a default stat. 

.pull-left[

```{r stat-1}
gapminder %>%
  ggplot(aes(x = continent)) +
  geom_bar(stat = "count") # default
```

`stat = "count"` automatically computes the number of rows for each category.

]

.pull-right[

```{r stat-2}
gapminder %>% count(continent) %>%
  ggplot(aes(x = continent, y = n)) +
  geom_bar(stat = "identity")
```

`stat = "identity"` requires to specify a variable that is mapped to `y` (bar height).

]

???

You can add `stat_*()` layers to the graph, but this is not required most of the time.

---

## Position adjustment

```{r}
selected_c <- c("Germany", "France", "Italy", "United States", "Canada")
s07 <- filter(gapminder, year == 2007, country %in% selected_c)
```


.pull-left[

```{r pos-bar-1, fig.width=6.5, fig.height=2.25}
ggplot(s07, aes(continent, fill = country)) +
  geom_bar() # default: position_stack() #<<
```

{{content}}

]

--

```{r pos-bar-2, fig.width=6.5, fig.height=2.25}
ggplot(s07, aes(continent, fill = country)) +
  geom_bar(position = position_stack()) #<<
```

--

.pull-right[

```{r pos-bar-3, fig.width=6.5, fig.height=2.25}
ggplot(s07, aes(continent, fill = country)) +
  geom_bar(position = position_dodge()) #<<
```

{{content}}

]

--

```{r pos-bar-4, fig.width=6.5, fig.height=2.25}
ggplot(s07, aes(continent, fill = country)) +
  geom_bar(position = position_fill()) #<<
```

---

## Position adjustment

```{r}
g07 <- filter(gapminder, year == 2007)
```


.pull-left[

```{r pos-1, fig.width=16/2.54, fig.height=7/2.54}
ggplot(data = g07,
       aes(gdpPercap, lifeExp)) +
  geom_point()
```

]

--

.pull-right[

```{r pos-2, fig.width=16/2.54, fig.height=7/2.54}
ggplot(data = g07,
       aes(gdpPercap, lifeExp)) +
  geom_point(position = #<<
               position_jitter(width = 3000, #<<
                               height = 0)) #<<
```

]

---

class: middle, exercise-blue

## Your turn `r (yt_counter <- yt_counter + 1)`

`r countdown::countdown(minutes = 3)`

Recreate the following barchart which shows the number of countries per 
continent and population size category. 

```{r echo=FALSE, fig.align='center', out.width="50%"}
knitr::include_graphics(file.path(fig_path, "yt_bar.png"))
```

All bars should have exactly the same width. 
Hint: see the documentation of `?position_dodge` to 
look up the argument that _preserves_ the width of a single bar at a position. 

???

```{r ex-bar-stacked, echo=FALSE, fig.width=24/2.54, fig.height=4.5, eval=FALSE}
```

There are two types of bar charts: geom_bar() and geom_col(). geom_bar() makes the height of the bar proportional to the number of cases in each group (or if the weight aesthetic is supplied, the sum of the weights). If you want the heights of the bars to represent values in the data, use geom_col() instead.

---

## Scales

- every aesthetic inside `aes()` will have a scale
- aesthetic will get a default scale if no scale is explicitely provided
- scale names follow an intuitve scheme: `scale_<AES>_<TYPE>()`
  - `scale_<AES>_continuous()` 
  - `scale_<AES>_discrete()` 
  - `scale_<AES>_manual()`
  - `scale_{color,fill}_brewer()` 
  - `scale_{color,fill}_distiller()` 
  - `scale_{color,fill}_gradient()`
  - ...

---

## Axis scales

```{r scale-0, fig.height=10/2.54}
(p <- ggplot(gapminder,
            aes(x = gdpPercap, y = lifeExp)) +
  geom_point())
```

The x- and y-axis scales default to `scale_x_continuous()` and 
`scale_y_continuous()`, respectively. We do not need to explicitely add these layers to the graph.

Since the graph reveals a log relationship between GDP per capita and life expectancy, 
we may improve it by log-transforming x-axis.

---

## Axis scales


.pull-left[

```{r, scale-0-log10, fig.height=10/2.54}
p + scale_x_log10()
```

]

--

.pull-right[

```{r, scale-0-log10-comma, fig.height=10/2.54}
p + scale_x_log10(
  limits = c(200, 150000), # value range
  breaks = c(500, 5000, 50000), # ticks pos.
  labels = scales::comma # alternative...
  # ...labeling function
) 
```

]


.font80[

.content-box-green[

Tip: In RStudio, write `scale_x_` and press **Tab ↹** or **Ctrl + SPACE ␣"** 
to get autocomplete suggestions  
of available x-axis scale transformation functions.

]


]


---

## Color scales

```{r scale-fill-0, fig.width=16/2.54}
ggplot(gapminder, aes(x = continent, fill = continent)) +
  geom_bar() # + scale_fill_discrete() 
```

Based on the vector type of the `continent` color, a **discrete** color scale 
is picked.

---

## Color scales

We can replace this default color scale by adding a different `scale_fill_*` 
layer. 

.pull-left60[

```{r scale-fill, fig.width=16/2.54}
ggplot(gapminder, aes(x = continent, fill = continent)) +
  geom_bar() +
  scale_fill_brewer(palette = "Dark2") #<<
```

]

.pull-right40[

```{r colorbrewer, fig.height=20/2.54}
RColorBrewer::display.brewer.all()
```

```{r colorbrewer-nice-try, echo=FALSE, eval=FALSE, fig.height=20/2.54}
library(showtext)
font_add("Fira Sans", regular = "FIRASANS-BLACK.ttf")
par("family" = "Fira Sans")
par("family")
grDevices::quartzFonts(fira = c("Fira Sans Regular", "Fira Sans Bold", "Fira Sans Italic", 
        "Fira Sans Bold Italic"))
windowsFonts(fira = windowsFont("Fira Sans"))
par("family")
par(family = "fira")

RColorBrewer::display.brewer.all()
```

<!-- .caption[Colorbrewer color scales] -->

]

.footnote[

[colorbrewer2.org](http://colorbrewer2.org/)

]

---

```{r colorspace-1, fig.width=30/2.54, fig.height=17/2.54, fig.align="left"}
colorspace::hcl_palettes(plot = TRUE)
```

&rarr; .font150[`colorspace::scale\_<AES>\_<TYPE>\_<COLORSCALE>(palette = <PALETTE-NAME>)`]

---

.font150[`colorspace::scale\_<AES>\_<TYPE>\_<COLORSCALE>(palette = <PALETTE-NAME>)`]

```{r colorspace-2}
ggplot(gapminder,
       aes(x = gdpPercap, y = lifeExp, color = lifeExp)) +
  geom_point() +
  colorspace::scale_color_continuous_sequential("Magenta") #<<
```

---

```{r all-colors-prep, echo=FALSE}
cc <- stringr::str_subset(colors(distinct = TRUE), "^gr[ae]y", negate = TRUE)
ll <- length(cc)

cc1 <- cc[1:(round(ll/2))]
cc2 <- cc[(round(ll/2)+1):ll]
```

```{r all-colors, eval=FALSE}
scales::show_col(colors()) # colors() returns the built-in color names
```

.pull-left[

```{r all-colors-silent-1, fig.width=20/2.54, fig.height=20/2.54, echo=FALSE}
scales::show_col(cc1, cex_label = 0.45)
```

]

.pull-right[

```{r all-colors-silent-2, fig.width=20/2.54, fig.height=20/2.54, echo=FALSE}
scales::show_col(cc2, cex_label = 0.45)
```

]

???

R understands `r length(colors())` color names.


---

## Further examples of scale adjustments

```{r scale-1-prep}
ge7 <- gapminder %>% filter(year == 2002, continent == "Europe")
```


.pull-left[

```{r scale-1}
ggplot(ge7, aes(gdpPercap, lifeExp)) + 
  geom_point()
```

]

--

.pull-right[

```{r scale-2}
ggplot(ge7, aes(gdpPercap, lifeExp)) + 
  geom_point() +
  scale_x_continuous(breaks = seq(8000, 40000, #<< 
                                  8000)) #<<
```

]

---

.pull-left[

```{r scale-3}
ggplot(ge7, aes(gdpPercap, lifeExp)) + 
  geom_point() +
  scale_y_continuous(limits = c(65, 85)) #<<
```

]


--

.pull-right[

```{r scale-4}
ggplot(ge7, aes(gdpPercap, lifeExp)) + 
  geom_point() +
  scale_y_continuous(limits = c(70, 85), 
                     breaks = c(70, 85), #<< 
                     labels = c("70", "85 yrs")) #<<
```

]

---

class: middle, exercise-blue

## Your turn `r (yt_counter <- yt_counter + 1)`

`r countdown::countdown(minutes = 5)`

Recreate the scatterplot below. 
There are 2 `geom_point()` layers: one layer that shows a semi-transparent point for 
every country and one layer that shows red points for American countries and 
blue points for European countries.

```{r ex-manual-color, echo=FALSE, fig.align='center', out.width="50%"}
knitr::include_graphics(file.path(fig_path, "yt-manual-scale.png"))
```

???

```{r ex-manual-color-sol, fig.width=16/2.54, eval=FALSE}
```

---

## Facetting

One of the highlights of `ggplot2` is the possibility to easily **facet** a plot, 
i.e. splitting the data onto multiple panels. 

Facetting enables to compactly present a lot of information by **stratifying by a third variable**.

Also, faceting often is a remedy against **overplotting**.

```{r facet-1, fig.width=10}
p <- ggplot(data = gapminder, mapping = aes(x = year, y = gdpPercap))
p + geom_line(aes(group = country)) +
  scale_y_log10() +
  facet_wrap(~ continent) #<<
```

???

Wenn wir die Beziehung zwischen 2 Variablen darstellen, kann es sein, dass eine andere Variable diese Beziehung verschleiert (Confounding). Zum Beispiel könnte es sein, dass der Kontinent einen Einfluss auf die Entwicklung des BIPs hat.

Afrika: Absolutes wirtschaftliches Wachstum ist geringer als in Europa

- besser grafisch aufbereiten, und Trendlinie hinzufügen

---

## Facetting

```{r facet-2, fig.width=20/2.54, fig.height=10/2.54}
p <- ggplot(data = gapminder %>% filter(continent != "Oceania"), aes(x = year,y = gdpPercap))
p + geom_line(aes(group = country)) +
  geom_smooth(method = "loess", se = FALSE) +
  scale_x_continuous(breaks = seq(1960, 2000, 20)) + scale_y_log10(labels = scales::dollar) +
  facet_wrap(~ continent, nrow = 1) + #<<
  labs(x = NULL, y = "GDP per capita")
```

.font80[.content-box-green[Instead of the formula notation (`~`), you can alternatively 
specify faceting variables with `vars()`, e.g. `facet_wrap(vars(continent))`]]

???

- loess: nicht-lineare, nicht-parametrische Regression
- facetting variables are specified in formula notation http://r4ds.had.co.nz/model-basics.html

---

## `facet_wrap()` vs. `facet_grid()`

- `facet_wrap()`: sequence of panels 
- `facet_grid()`: matrix of panels

--

Show GDP development, stratified by life expectancy groups:

```{r facet-3-prep}
my_gapminder <- gapminder %>%  filter(continent %in% c("Africa", "Asia", "Europe")) %>%
  group_by(country) %>% mutate(lifeExp = if_else(max(lifeExp)<75, "lifeExp < 75", "lifeExp >= 75"))
p <- ggplot(data = my_gapminder, mapping = aes(x = year, y = gdpPercap)) +
  geom_line(aes(group = country)) +
  scale_x_continuous(breaks = seq(1960, 2000, 20)) +
  scale_y_log10(labels = scales::dollar)
```

--

.pull-left[


```{r facet-3-wrap, fig.width=9}
p + facet_wrap(~ continent + lifeExp) #<<
```

]

--

.pull-right[

```{r facet-3-grid, fig.width=9}
p + facet_grid(continent ~ lifeExp) #<<
```

]

---

## Labels

```{r labs, fig.width=8, fig.height=5}
p +
  labs(
    x = "GDP per capita",
    y = "Life expectancy",
    color = "Continent",
    title = "Relationship between GDP per capita\nand life expectancy",
    subtitle = "<subtitle>",
    caption = "<caption>",
    tag = "A"
  )
```

---

class: middle, exercise-blue

## Your turn `r (yt_counter <- yt_counter + 1)`

`r countdown::countdown(minutes = 7)`

Recreate the graph below. For each of the three continents, show the 
percental average population growth from 1952 to 2007 in a facetted plot.

```{r ex-facet, echo=FALSE, fig.align='center', out.width="50%"}
knitr::include_graphics(file.path(fig_path, "yt_facet.png"))
```

.font80[

1. Prepare the data. Filter the continents Africa, Asia and Europe, then calculate the mean population by continent and year. For each year, calculate the relative population growth from 1952.
2. Plot the data. Read the documentation for bar charts (`?geom_bar`) to decide whether you have to use the `geom_bar()` or `geom_col()` geom. Use `facet_wrap()` to create a subplot for each continent. Format the y-axis labels using `scales::percent`. Add a custom color scale for the bar filling.

]

???

```{r ex-facet-data, echo = FALSE, eval = FALSE}
```

```{r ex-facet-plot, echo = FALSE, fig.width=8, fig.height=3.5, eval = FALSE}
```

---

## Coordinates

Specify on what type of canvas the data should be drawn on. 

.pull-left[

```{r coord-prep}
# Calculate average relative population growth 
# from 1952 to 2007 per continent 
(gc <- gapminder %>%
  filter(year %in% c(1952, 2007)) %>%
  group_by(continent, year) %>%
  summarize(avg_pop = mean(pop)) %>%
  group_by(continent) %>%
  summarize(rel_pop_growth = 
              (avg_pop[2]-avg_pop[1]) / 
              avg_pop[1]))
```

]


.pull-right[

```{r coord-1}
ggplot(gc, aes(x=continent, y=rel_pop_growth)) +
  geom_col() +
  coord_polar() + #<<
  scale_y_continuous(labels = scales::percent)
```

A polar coordinate system interprets x as **radius** and y as **angle**.

]

---

## Coordinates

For **zooming**, use `coord_*` layers instead of `scale_*` layers.

.pull-left[

```{r coord-2, warning=TRUE, R.options=list(width = 50), fig.height = 10/2.54}
ggplot(gc, aes(x=continent, y=rel_pop_growth)) +
  geom_col() +
  scale_y_continuous(limits = c(0, 1.7)) #<<
```

.font120[When using `scale_*`, data outside of the limits will be removed.]

]

.pull-right[

```{r coord-3, warning=TRUE, fig.height = 10/2.54}
ggplot(gc, aes(x=continent, y=rel_pop_growth)) +
  geom_col() +
  coord_cartesian(ylim = c(0, 1.7)) #<<
```

.font120[When using `coord_*`, data outside of the limits will not be removed.]

]

---

`coord_flip()` flips cartesian coordinates. It is very useful when you have a 
lot of categories on the x-axis or want to display
very long labels.

```{r coord-4}
gf <- filter(gapminder, year == 2007, continent == "Americas")
```

.pull-left[

```{r coord-5, fig.height=13/2.54}
ggplot(gf, aes(country, pop)) +
  geom_col()
```

]

.pull-right[

```{r coord-6, fig.height=13/2.54}
ggplot(gf, aes(country, pop)) + geom_col() +
  coord_flip() #<<
```

]

By swapping horizontal and vertical axes, the country names become readable.

---

## Themes

Use a theme layer to change style aspects of the plot that are not related to 
the data. 

Apply a build-in theme with `theme_<NAME>` to quickly change the overall appearance:

```{r themes-1-2, fig.width = 14/2.54, fig.height = 10/2.54, fig.align='center'}
p <- ggplot(gapminder, aes(x = gdpPercap, y = lifeExp, color = continent)) + geom_point()
p + theme_gray() # default theme
```

.font100[

> The signature ggplot2 theme with a grey background and white gridlines, designed to put the data forward yet make comparisons easy. &mdash; `?theme_grey`

]

---

class: middle

```{r themes-3, fig.width = 14/2.54, fig.align='center'}
p + theme_bw()
```

> The classic dark-on-light ggplot2 theme. May work better for presentations displayed with a projector. &mdash; `?theme_bw`

---

class: middle

```{r themes-4, fig.width = 14/2.54, fig.align='center'}
p + theme_minimal()
```

> A minimalistic theme with no background annotations. &mdash; `?theme_minimal`

---

class: middle

```{r themes-5, fig.width = 14/2.54, fig.align='center'}
p + theme_void()
```

> A completely empty theme. &mdash; `?theme_void`

---

## `ggthemes`

```{r gg-themes, echo=FALSE, out.width="100%"}
knitr::include_url("https://yutannihilation.github.io/allYourFigureAreBelongToUs/ggthemes/", 
                   height = "500px")
```

https://yutannihilation.github.io/allYourFigureAreBelongToUs/ggthemes/

---

class: middle

The `ggthemes` package provides additional themes.

```{r themes-6, fig.width = 14/2.54, fig.align='center'}
p + ggthemes::theme_base()
```

> Theme similar to the default settings of the 'base' R graphics. &mdash; `?theme_base`

---

class: middle

```{r themes-7, fig.width = 14/2.54, fig.align='center'}
p + ggthemes::theme_excel_new()
```

> Theme for ggplot2 that is similar to the default style of charts in current versions of Microsoft Excel. &mdash; `?theme_excel_new`

---

## Modifying base theme properties

```{r themes-9, fig.width=25/2.54, fig.height=14/2.54}
p + 
  theme_minimal(base_size = 24, base_family = "serif")
```

---

## Modifying single theme elements

Modify individual theme elements with `theme(<ELEMENT> = ...)` 

```{r themes-10, fig.width=25/2.54, fig.height=14/2.54}
p + 
  theme_minimal(base_size = 24) +
  theme(axis.title = element_text(colour = "red", hjust = 1))
```

---

## Modifying single theme elements

```{r themes-11, fig.width=25/2.54, fig.height=14/2.54}
p + 
  theme_minimal(base_size = 24) +
  theme(axis.line = element_line())
```

---

## Modifying single theme elements

```{r themes-12, fig.width=25/2.54, fig.height=14/2.54}
p + 
  theme_minimal(base_size = 24) +
  theme(panel.grid.minor = element_blank())
```

---

## Modifying single theme elements

```{r themes-13, fig.width=25/2.54, fig.height=14/2.54}
p + 
  theme_minimal(base_size = 24) +
  theme(legend.background = element_rect(fill = "yellow"))
```

---

## Modifying single theme elements

```{r themes-14, fig.width=25/2.54, fig.height=14/2.54}
p + 
  theme_minimal(base_size = 24) +
  theme(legend.position = "top")
```

---

## Advanced: Extracting plot details

One of the main reasons why `ggplot2` is easy to use, is that it makes the required computations for a lot of geoms by itself. 
For example, the boxplot geom automatically calculates the values for the 5-point summary and identifies possible outliers.

.pull-left[

```{r extract-plot-details-1}
p <- ggplot(iris, aes(Species, Sepal.Length)) + 
   geom_boxplot()
p
```

]

.pull-right[

```{r extract-plot-details-1b}
class(p)
```

&nbsp;

.content-box-yellow[&#x1F914; _"I need to depict the summary statistics of the boxplot for 
my final project report. How can I extract them?"_]

]

???

- ggplot automatically calculates the 5-point summary for a boxplot
  - median, 1. and 3. quartile, whisker lengths and outliers

---

## Advanced: Extracting plot details

Whenever a ggplot object is "printed" to the screen, 
the function `ggplot_build()` is invoked internally to render the plot.

```{r extract-plot-details-2}
gr <- ggplot_build(p) # execute all necessary steps to render the plot
class(gr)
names(gr)
```

The three components of a `ggplot_built` object are: 

- `data`: details for each plot layer, e.g. the 5-point summary of a boxplot.
- `layout`: axis information, e.g. breaks, ranges and labels
- `plot`: the rendered plot itself

---

## Advanced: Extracting plot details

We are interested in the 5-point summary of the 3 boxplots, 
which were automatically calculated by `ggplot2`. 
We extract the information from the `data` element of `gr`.

```{r extract-plot-details-3}
gr$data[[1]] # or: layer_data(p, i = 1)
```

```{r, include=F}
# ### Accessing and modifying existing
# 
# Underlying every `ggplot2` object is a collection of lower-level _graphical objects_ (**_grobs_**).
# 
# Access grobs via `ggplotGrob()`:
# 
# # ```{r}
# g <- ggplotGrob(p)
# g
# #```
# 
# #```{r}
# g$grobs[[15]]
# grid.draw(g$grobs[[15]])
# library(gtable)
# gtable_show_layout(g$grobs[[15]])
# #```
```

---

## Maps &#x1F5FA;

Example **choropleth maps** showing the poll results of the 2016 United States Presidential Elections:

```{r, echo=FALSE, out.width="625px"}
knitr::include_graphics(file.path(fig_path, "usa_map.png"))
```

.footnote[Figure source: Kieran Healy. ["Data Visualization. A practical introduction"](http://socviz.co/). 
Princeton University Press, 2018.]

---

## Maps &#x1F5FA;

Draw a map of the USA:

```{r map-0, message = FALSE}
usa <- map_data("state")
str(usa)
```

--

.pull-left[

```{r map-usa, eval = FALSE}
ggplot(usa, aes(x = long, y = lat,
                group = group)) +
  geom_polygon(color = "black", fill = NA) + #<<
  coord_map() +
  theme_void()
```

]

.pull-right[
```{r, ref.label="map-usa", echo=FALSE, fig.height=2.5}
```

]

---

## Interactive graphs with ggiraph

Create a map that shows the 2016 US Presidential Elections Results. 
By hovering over a state, a tooltip should pop up showing the percentages of 
the presidential candidates of the Democratic and Republican parties, respectively.

```{r interactive-map, fig.width=25/2.54, fig.height=18/2.54}
library(ggiraph)
p <- usa %>% rename(state = region) %>%
  mutate(state = stringr::str_to_title(state)) %>%
  mutate(state = if_else(state == "District Of Columbia", "District of Columbia", state)) %>%
  left_join(socviz::election %>% select(state, winner, pct_clinton, pct_trump), by = "state") %>%
  mutate(tooltip = paste0(winner, " won ", state, "\nClinton: ", pct_clinton, "%\nTrump: ", pct_trump, "%")) %>%
  ggplot(aes(long, lat, group = group)) +
  geom_polygon_interactive(aes(fill = winner, data_id = state, tooltip = tooltip), color = "gray90") +
  scale_fill_manual(values = c("royalblue3", "firebrick2")) +
  labs(title = "2016 US Presidential Elections Results", fill = "Winning\ncandidate") +
  coord_map() +
  theme_void(base_family = "Fira Sans", base_size = 18)
```

```{r interactive-map-muted, eval = FALSE}
girafe(ggobj = p)
```

???

maybe useful: https://github.com/davidgohel/budapestbi2017/blob/master/docs/ggiraph/slides.Rmd

---

class: center, middle

```{r interactive-map-silent, eval = FALSE, echo = FALSE}
htmlwidgets::saveWidget(
  girafe(ggobj = p, width_svg = 25/2.54, height_svg = 25*9/16/2.54,
       options = list(opts_tooltip(css = "font-family:Fira sans;background-color:black;color:white;padding:5px;"))
       ),
  file.path("figures", "03-ggplot2", "ggiraph_usa-2016.html") #!!
)
```

```{r interactive-map-import-html, echo = FALSE, out.width="95%"}
knitr::include_url("figures/03-ggplot2/ggiraph_usa-2016.html", height = "600px")
```


---

## Draw maps from shape files

The `maps` package contains map data only for a handful of countries, 
including USA, France, Italy and New Zealand, as well as 2 world maps.

Generally, **shapefiles** are more flexible in accessing geographic and political boundaries 
than built-in maps. A shapefile is **geospatial vector data format** for geographic 
information system (GIS) software.

Shapefiles actually consist of several sub-files, see e.g. [Wikipedia](https://en.wikipedia.org/wiki/Shapefile).

---

## Save plots &#x1F4BE;

```{r ggsave, eval = FALSE}
ggsave("filename.png", 
       plot = p, # if not specified saves plot that was created last 
       width = 8, height = 6, 
       units = "cm", dpi = 300)
```

---

## `ggplot2` Template

&nbsp;

&nbsp;

```{r ggplot2-template, echo=FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "ggplot2_template.png"))
```

---


class: middle, exercise-blue

## Your turn `r (yt_counter <- yt_counter + 1)`

`r countdown::countdown(minutes = 15)`

Create the following graph. 

```{r ex-gapminder, echo=FALSE, fig.align='center', out.width="70%"}
knitr::include_graphics(file.path(fig_path, "yt-gapminder.png"))
```


???

```{r change-theme, include = FALSE}
th <- theme_get() 

theme_set(th %+replace%
  theme(text = element_text(size = 14))
)
```


```{r gapminder, echo = FALSE, fig.width=8, fig.height=5, warning=TRUE, message = TRUE, eval=FALSE}
```

```{r scale_linetype-alter, eval = FALSE, include=FALSE}
# Alternativen
scale_linetype(labels = list(bquote(R^2==.(mr2)))) +
scale_linetype(labels = list(latex2exp::TeX(paste0("$R^2=", mr2, "$")))) +
```


---

class: exercise-blue

## Step `r (fec <- 1)`: create basic scatterplot

.pull-left60[

```{r e0101, fig.width=7}
g07 <- filter(gapminder, year == 2007)
ggplot(g07, aes(x = gdpPercap, y = lifeExp, 
                      color = continent)) +
  geom_point()
```

]

.pull-right40[

.content-box-yellow[

&#x1F4C8; **Enhancements:**  
&#x2B1C; replace point symbol with a circle  
&#x2B1C; increase point size

Available point symbols:

```{r pch, out.width="100%", echo=FALSE}
knitr::include_graphics(file.path(fig_path, "r-pch.png"))
```

]

]

---

class: exercise-blue

## Step `r fec`: create basic scatterplot

.pull-left60[

```{r e0102, fig.width=7}
ggplot(g07, aes(x = gdpPercap, y = lifeExp, 
                      color = continent)) + 
  geom_point(shape = 1, size = 2)
```

]

.pull-right40[

.content-box-yellow[

&#x1F4C8; **Enhancements:**  
&#x2714;&#xFE0F; replace point symbol with a circle  
&#x2714;&#xFE0F; increase point size  
&#x2B1C; increase line width of points  
&#x2B1C; change color scale to Colorbrewer's "Set2"

```{r, echo=FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "colorbrewer.png"))
```

]

]

---

class: exercise-blue

## Step `r fec`: create basic scatterplot

.pull-left60[

```{r e0103, fig.width=7}
ggplot(g07, aes(x = gdpPercap, y = lifeExp, 
                      color = continent)) + 
  geom_point(shape = 1, size = 2, stroke = 1.5) +
  scale_color_brewer(palette = "Set2")
```

]

.pull-right40[

.content-box-yellow[

&#x1F4C8; **Enhancements:**  
&#x2714;&#xFE0F; replace point symbol with a circle  
&#x2714;&#xFE0F; increase point size  
&#x2714;&#xFE0F; increase line width of points  
&#x2714;&#xFE0F; change color scale to Colorbrewer's "Set2"  
&#x2B1C; add regression curve

]

]

---

class: exercise-blue

## Step `r (fec <- fec + 1)`: add regression curve

.pull-left60[

```{r e0104, fig.width=7}
ggplot(g07, aes(x = gdpPercap, y = lifeExp, 
                      color = continent)) + 
  geom_point(shape = 1, size = 2, stroke = 1.5) +
  scale_color_brewer(palette = "Set2") +
  geom_smooth(method = "lm", formula = "y ~ x + log(x)")
```

]

.pull-right40[

.content-box-yellow[

&#x1F4C8; **Enhancements:**  
&#x2B1C; add **global** regression curve  
&#x2B1C; place regression curve layer below scatterplot layer   

]

]

---

class: exercise-blue

## Step `r fec`: add regression curve

.pull-left60[

```{r e0105, fig.width=7}
ggplot(g07, aes(x = gdpPercap, y = lifeExp)) +
  geom_smooth(method = "lm", formula = "y ~ x + log(x)") +
  geom_point(aes(color = continent), shape = 1, size = 2, 
             stroke = 1.5) +
  scale_color_brewer(palette = "Set2")
```

]

.pull-right40[

.content-box-yellow[

&#x1F4C8; **Enhancements:**  
&#x2714;&#xFE0F; add **global** regression curve  
&#x2714;&#xFE0F; place regression curve layer below scatterplot layer   
&#x2B1C; make manual log regression model  
&#x2B1C; add R² value as curve legend  

]

]

&#x1F914; _In general, `geom_smooth()` works like a charm, but here we need to manually compute the regression model to extract the R² value._

---

class: exercise-blue

## Step `r fec`: add regression curve

```{r e0105-reg1}
# regression fit with log-transformed independent variable
(m <- lm(lifeExp ~ gdpPercap + log(gdpPercap), data = g07))
```

--

```{r e0105-reg2}
# extract coefficient of determination aka R²
(mr2 <- round(summary(m)$r.squared, 3))
```

--

```{r e0105-reg3}
# apply model to 100 equi-distant values along the range of gdpPercap
prd <- tibble(gdpPercap = seq(min(g07$gdpPercap), max(g07$gdpPercap), length.out = 100))
prd$lifeExp <- predict(m, prd)
head(prd)
```

---

class: exercise-blue

## Step `r fec`: add regression curve

.pull-left60[

```{r e0106, fig.width=7}
ggplot(g07, aes(x = gdpPercap, y = lifeExp)) +
  geom_point(aes(color = continent), shape = 1, size = 2, 
             stroke = 1.5) +
  geom_line(data = prd) + 
  scale_color_brewer(palette = "Set2")
```

]

.pull-right40[

.content-box-yellow[

&#x1F4C8; **Enhancements:**  
&#x2714;&#xFE0F; add **global** regression curve  
&#x2714;&#xFE0F; place regression curve layer below scatterplot layer   
&#x2714;&#xFE0F; make manual log regression model  
&#x2B1C; add R² value as curve legend  
&#x2B1C; regression curve: increase line width + change color to red    

]

]

&#x1F914; _How can we force `ggplot2` to create a legend for the regression curve?_

---

class: exercise-blue

## Step `r fec`: add regression curve

.pull-left60[

```{r e0107, fig.width=7}
ggplot(g07, aes(x = gdpPercap, y = lifeExp)) +
  geom_point(aes(color = continent), shape = 1, size = 2, 
             stroke = 1.5) +
  geom_line(data = prd, aes(linetype = "r2"), size = 1.5, 
            color = "red") +
  scale_color_brewer(palette = "Set2")
```

]

.pull-right40[

.content-box-yellow[

&#x1F4C8; **Enhancements:**  
&#x2714;&#xFE0F; add **global** regression curve  
&#x2714;&#xFE0F; place regression curve layer below scatterplot layer   
&#x2714;&#xFE0F; make manual log regression model  
&#x2714;&#xFE0F; add R² value as curve legend  
&#x2714;&#xFE0F; regression curve: increase line width + change color to red   
&#x2B1C; add labels for selected countries

]

]

---

class: exercise-blue

## Step `r (fec <- fec + 1)`: add country labels

.pull-left60[

```{r e0108, fig.width=7}
ctr <- c("Afghanistan", "Argentina", "Bangladesh", "Botswana", "Brazil", "Canada", "China",  "Cameroon", "Germany", "Greece", "India", "Iraq", "Italy", "Japan", "Malaysia", "New Zealand",  "Norway", "Rwanda", "Singapore", "South Africa", "Sudan", "United States", "Venezuela")
ggplot(g07, aes(x = gdpPercap, y = lifeExp)) +
  geom_point(aes(color = continent), shape = 1, size = 2, 
             stroke = 1.5) +
  geom_line(data = prd, aes(linetype = "r2"), size = 1.5, 
            color = "red") +
  geom_text(data = filter(g07, country %in% ctr), #<<
            aes(label = country), fontface = "italic") + #<<
  scale_color_brewer(palette = "Set2")
```

]

.pull-right40[

.content-box-yellow[

&#x1F4C8; **Enhancements:**  
&#x2714;&#xFE0F; add labels for selected countries   
&#x2B1C; minimize overlap of labels   

]

.content-box-green[

```{r ggrepel, echo = FALSE, out.width="200px"}
knitr::include_graphics(file.path(fig_path, "ggrepel.png"))
```

.font100[The `ggrepel` package contains the geoms `geom_text_repel()` and 
`geom_label_repel()` to add non-overlapping labels that do not clip the panel 
boundaries.]

]

]

---

class: exercise-blue

## Step `r fec`: add country labels

.pull-left60[

```{r e0109, fig.width=7}
library(ggrepel)
ggplot(g07, aes(x = gdpPercap, y = lifeExp)) +
  geom_point(aes(color = continent), shape = 1, size = 2, 
             stroke = 1.5) +
  geom_line(data = prd, aes(linetype = "r2"), size = 1.5, 
            color = "red") +
  geom_text_repel(data = filter(g07, country %in% ctr), #<<
            aes(label = country), fontface = "italic") + #<<
  scale_color_brewer(palette = "Set2")
```

]

.pull-right40[

.content-box-yellow[

&#x1F4C8; **Enhancements:**  
&#x2714;&#xFE0F; add labels for selected countries   
&#x2714;&#xFE0F; minimize overlap of labels   
&#x2B1C; improve labels of axes and legends

]

]

---

class: exercise-blue

## Step `r (fec <- fec + 1)`: adjust labels

.pull-left60[

```{r e0110, fig.width=7, fig.height = 10.5/2.54}
ggplot(g07, aes(x = gdpPercap, y = lifeExp)) +
  geom_point(aes(color = continent), shape = 1, size = 2, stroke = 1.5) +
  geom_line(data = prd, aes(linetype = "r2"), size = 1.5, color = "red") +
  geom_text_repel(data = filter(g07, country %in% ctr), aes(label = country), fontface = "italic") +
  scale_color_brewer(palette = "Set2") +
  scale_x_continuous(limits = c(0, 52000), #<<
                     expand = expansion(mult = 0, add = 0), #<< 
                     labels = scales::dollar) + #<<
  labs(x = "Average GDP/capita", #<<
   y = "Average life expectancy [years]", #<<
   title = "Economic growth and life expectancy in 2007", #<<
   caption = "Source: Gapminder", linetype=NULL, color=NULL) #<<
```

]

.pull-right40[

.content-box-yellow[

&#x1F4C8; **Enhancements:**  
&#x2714;&#xFE0F; improve labels of axes and legends  
&#x2B1C; display actual R² value instead of placeholder text

]

]

---

class: exercise-blue

## Step `r (fec)`: adjust labels

.pull-left60[

```{r e0111, fig.width=7}
ggplot(g07, aes(x = gdpPercap, y = lifeExp)) +
  geom_point(aes(color = continent), shape = 1, size = 2, stroke = 1.5) +
  geom_line(data = prd, aes(linetype = "r2"), size = 1.5, color = "red") +
  geom_text_repel(data = filter(g07, country %in% ctr), aes(label = country), fontface = "italic") +
  scale_color_brewer(palette = "Set2") +
  scale_linetype(labels = paste0("R²=", mr2)) + #<<
  scale_x_continuous(limits = c(0, 52000), expand = expansion(mult = 0, add = 0), labels = scales::dollar) +
  labs(x = "Average GDP/capita", y = "Average life expectancy [years]", title = "Economic growth and life expectancy in 2007", caption = "Source: Gapminder", linetype = NULL, color = NULL)
```

]

.pull-right40[

.content-box-yellow[

&#x1F4C8; **Enhancements:**  
&#x2714;&#xFE0F; improve labels of axes and legends  
&#x2714;&#xFE0F; display actual R² value instead of placeholder text  
&#x2B1C; modify theme &rarr; 
first, choose theme that looks similar to the anticipated graph; second, adjust 
individual elements

]

]

---

class: exercise-blue

## Step `r (fec <- fec + 1)`: modify theme

.pull-left60[

```{r e0112, fig.width=7}
p <- ggplot(g07, aes(x = gdpPercap, y = lifeExp)) +
  geom_point(aes(color = continent), shape = 1, size = 2, stroke = 1.5) +
  geom_line(data = prd, aes(linetype = "r2"), size = 1.5, color = "red") +
  geom_text_repel(data = filter(g07, country %in% ctr), aes(label = country), fontface = "italic") +
  scale_color_brewer(palette = "Set2") +
  scale_linetype(labels = paste0("R²=", mr2)) + #<<
  scale_x_continuous(limits = c(0, 52000), expand = expansion(mult = 0, add = 0), labels = scales::dollar) +
  labs(x = "Average GDP/capita", y = "Average life expectancy [years]", title = "Economic growth and life expectancy in 2007", caption = "Source: Gapminder", linetype = NULL, color = NULL)
p + theme_minimal(base_size = 16) #<<
```

]

.pull-right40[

.content-box-yellow[

&#x1F4C8; **Enhancements:**  
&#x2B1C; modify theme:

- choose theme that looks similar to the anticipated graph
- show legend above panel (below title)
- add x-axis line and ticks
- remove minor grid
- add major horizontal grid

]

]

---

class: exercise-blue

## Step `r (fec)`: modify theme

.pull-left60[

```{r e0113, fig.width=8, fig.height=10.5/2.54}
p + theme_minimal(base_size = 16) +
 theme(legend.position = "top") +
 theme(axis.line = element_line(size = 0.4)) +
 theme(axis.line.y = element_blank()) +
 theme(axis.ticks = element_line(size = 0.3)) +
 theme(axis.ticks.y = element_blank()) +
 theme(panel.grid.minor = element_blank()) +
 theme(panel.grid.major.x = element_blank()) +
 theme(panel.grid.major.y = element_line(color = "grey60", 
                                          size = 0.5))
```

]

.pull-right40[

.content-box-yellow[

&#x1F4C8; **Enhancements:**  
&#x2714;&#xFE0F; modify theme:

- choose theme that looks similar to the anticipated graph
- show legend above panel (below title)
- add x-axis line and ticks
- remove minor grid
- add major horizontal grid

]

&nbsp;

<center>.font200[&#x1F973;]</center>

]

---

class: center, inverse, middle

# Extensions & Alternatives

---

background-image: url("figures/03-ggplot2/gg-ext.png")
background-size: contain


## [https://exts.ggplot2.tidyverse.org/gallery](https://exts.ggplot2.tidyverse.org/gallery)

---

## ggiraph

[`ggiraph`](https://davidgohel.github.io/ggiraph/): htmlwidget to extend `ggplot2` with `D3.js` 
to generate **animated** graphs

.pull-left70[

```{r ggiraph-us-elections-example-static, echo = FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "ggiraph_usa-2016.png"))
```

]

.pull-right30[

```{r ggiraph-logo, echo = FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "ggiraph.png"))
```

]

---

## plotly

[`plotly`](https://plot.ly/r): interface to eponymous Javascript library to 
create interactive graphs. 
The comfort function `ggplotly()` converts a `ggplot2` graph into a `plotly` 
graph

.pull-left70[

<div>
<iframe src="https://plot.ly/~RPlotBot/4645.embed" id="igraph" scrolling="no" seamless="seamless" width="507px" height="380px" frameborder="0"> </iframe>
</div>

]

.pull-right30[

```{r plotly-logo, echo=FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "plotly.png"))
```

]


---

## gganimate

[`gganimate`](https://github.com/thomasp85/gganimate): animated `ggplot2` graph

```{r gapminder-gganimate, echo = FALSE}
knitr::include_graphics(file.path(fig_path, "gapminder.gif"))
```

---

## gganimate

<video controls src="figures/03-ggplot2/corona-daily.mp4">corona-daily-course.mp4</video>

---

## ggforce

[`ggforce`](https://ggforce.data-imaginist.com/): various additional extensions to `ggplot2`

.pull-left70[

```{r ggforce, fig.width=23/2.54, fig.height=11/2.54}
library(ggforce)
ggplot(iris, aes(Sepal.Length, Petal.Width)) +
  coord_cartesian(xlim = c(3.5,8.5), ylim = c(-0.25,2.75), 
                  expand = F) +
  geom_point() +
  geom_mark_hull(aes(fill = Species, label = Species), 
                 concavity = 3)
```

]

.pull-right30[

```{r ggforce-logo, echo=FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "ggforce.png"))
```

]

---

## patchwork

[`patchwork`](https://ggforce.data-imaginist.com/): combine multiple different ggplot2 graphs into a composite plot

.pull-left70[

```{r patchwork, echo=FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "patchwork-example.png"))
```

]

.pull-right30[

```{r patchwork-logo, echo=FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "patchwork.png"))
```

]

---

## ggraph

[`ggraph`](https://cran.r-project.org/web/packages/ggraph/index.html): graph and network visualizations<sup>1</sup>

.pull-left[
```{r ext-1, echo=FALSE, out.width="300px"}
knitr::include_graphics(file.path(fig_path, "ggraph_1.gif"))
knitr::include_graphics(file.path(fig_path, "ggraph_2.png"))
```
]

.pull-right[
```{r ext-2, echo=FALSE, out.width="300px"}
knitr::include_graphics(file.path(fig_path, "ggraph_3.png"))
knitr::include_graphics(file.path(fig_path, "ggraph_4.png"))
```

]

---

## ggalluvial

`ggalluvial`: graphs for multi-dimensional categorical count data or repeated 
categorical measurement data<sup>1</sup> (Sankey diagrams)

.footnote[[1] URL: https://cran.r-project.org/web/packages/ggalluvial/index.html]

.pull-left[
```{r ext-5, echo=FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "ggaluvial_1.png"))
```
]

.pull-right[
```{r ext-6, echo=FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "ggaluvial_2.png"))
```
]

---

## `ggplot2` extensions

[`ggthemeassist`](https://github.com/calligross/ggthemeassist): WYSIWYG editor for `ggplot2` theme elements as Shiny app and RStudio addin.

<iframe width="622" height="350" src="https://www.youtube.com/embed/t8srbECpWYg?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>

---

background-image: url("figures/03-ggplot2/htmlwidgets.png")
background-size: contain

## Interactive graphs: [gallery.htmlwidgets.org](http://gallery.htmlwidgets.org/)

---

## r2d3

.pull-left70[

[`r2d3`](https://rstudio.github.io/r2d3/): `R` interface to [D3](https://d3js.org/) Javascript library.

```{r ext-4, echo=FALSE, out.width="90%"}
knitr::include_graphics(file.path(fig_path, "r2d3_gallery.png"))
```

]

.pull-right30[

```{r ext-3, echo=FALSE, out.width="100%"}
knitr::include_graphics(file.path(fig_path, "r2d3-hex.png"))
```

]

---

background-image: url("figures/03-ggplot2/ggplot2-abstraction-level.png")
background-size: contain

.footnote[[Kieran Healy. A Practical Introduction to Data Visualization with ggplot2 Workshop. rstudio::conf 2020.](https://github.com/rstudio-conf-2020/dataviz)]

---

## Further materials

.pull-left[

- **Hadley Wickham. ["ggplot2 - Elegant Graphics for Data Analysis"](https://link.springer.com/book/10.1007%2F978-0-387-98141-3). Springer, 2016.**
- Hadley Wickham, and Garrett Grolemund. ["R for Data Science"](http://r4ds.had.co.nz/). O'Reilly, 2017. Chapters: 
  - [Data Visualization](http://r4ds.had.co.nz/data-visualisation.html)
  - [Graphics for communication](http://r4ds.had.co.nz/graphics-for-communication.html)
- **Claus O. Wilke. ["Fundamentals of Data Visualization"](http://serialmentor.com/dataviz/). O'Reilly Media, 2018.**
- **Kieran Healy. ["Data Visualization. A practical introduction"](http://socviz.co/). Princeton University Press, 2018.**
- RStudio's [`ggplot2` cheat sheet](https://github.com/rstudio/cheatsheets/raw/master/data-visualization-2.1.pdf)
- ["awesome" ggplot2](https://github.com/erikgahner/awesome-ggplot2): curated list of various ggplot2 resources

]

.pull-right[

```{r material, echo=FALSE, out.width="33%"}
knitr::include_graphics(file.path(fig_path, "ggplot2_cover.jpg"))
knitr::include_graphics(file.path(fig_path, "healy_data_vis_cover.jpg"))
knitr::include_graphics(file.path(fig_path, "wilke_fundamentals_data_vis_cover.jpg"))
```

]

???

awesome ggplot2:

- new geoms: ridgeline plots, wordclouds
- additional themes
- books and online courses
- tutorials


---

background-image: url("figures/03-ggplot2/ggplot2-cheatsheet_1.png")
background-size: contain

???

https://github.com/rstudio/cheatsheets/raw/master/data-visualization-2.1.pdf

---

background-image: url("figures/03-ggplot2/ggplot2-cheatsheet_2.png")
background-size: contain

---

```{r, child="session_info.Rmd"}
```

---

class: last-slide, center, bottom

# Thank you! Questions?

&nbsp;

.courtesy[&#x1F4F7; Photo courtesy of Stefan Berger]